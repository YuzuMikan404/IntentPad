name: ğŸš€ ãƒ“ãƒ«ãƒ‰ & ãƒªãƒªãƒ¼ã‚¹

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚° (ä¾‹: v1.0.0)'
        required: true
        default: 'v1.0.0'
        type: string
      release_name:
        description: 'ãƒªãƒªãƒ¼ã‚¹å'
        required: true
        default: 'æ–°è¦ãƒªãƒªãƒ¼ã‚¹'
        type: string
      is_prerelease:
        description: 'ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹ï¼ˆãƒ™ãƒ¼ã‚¿ç‰ˆï¼‰ã¨ã—ã¦å…¬é–‹'
        required: true
        type: boolean
        default: false

env:
  CACHE_VERSION: v1

jobs:
  build-apk:
    name: ğŸ”¨ APKã‚’ãƒ“ãƒ«ãƒ‰
    runs-on: ubuntu-24.04
    permissions:
      contents: read

    steps:
      - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Javaç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: âš™ï¸ Gradleã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.5'
          cache-disabled: false

      - name: ğŸ› ï¸ ãƒªã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ/ä¿®æ­£
        run: |
          echo "=== ãƒªã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è£œå®Œ ==="
          mkdir -p app/src/main/res/xml
          
          # strings.xml
          if [ ! -f app/src/main/res/values/strings.xml ]; then
            mkdir -p app/src/main/res/values
            cat > app/src/main/res/values/strings.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <string name="app_name">IntentPad</string>
</resources>
EOF
            echo "strings.xmlã‚’ä½œæˆ"
          fi
          
          # file_paths.xml
          if [ ! -f app/src/main/res/xml/file_paths.xml ]; then
            cat > app/src/main/res/xml/file_paths.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<paths xmlns:android="http://schemas.android.com/apk/res/android">
    <external-path name="external_files" path="." />
</paths>
EOF
            echo "file_paths.xmlã‚’ä½œæˆ"
          fi
          
          # AndroidManifestä¿®æ­£ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ï¼‰
          if [ -f app/src/main/AndroidManifest.xml ]; then
            sed -i 's|@mipmap/ic_launcher|@android:drawable/sym_def_app_icon|g' app/src/main/AndroidManifest.xml
            sed -i 's|@mipmap/ic_launcher_round|@android:drawable/sym_def_app_icon|g' app/src/main/AndroidManifest.xml
            echo "AndroidManifest.xmlã‚’ä¿®æ­£ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³ä½¿ç”¨ï¼‰"
          fi

      - name: ğŸ“¦ Debug APKã‚’ãƒ“ãƒ«ãƒ‰
        run: |
          echo "=== APKãƒ“ãƒ«ãƒ‰é–‹å§‹ ==="
          echo "Gradleãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª:"
          gradle --version
          
          echo "ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ:"
          # ã“ã“ã§gradleã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ï¼ˆ./gradlewã§ã¯ãªã„ï¼‰
          gradle clean assembleDebug --no-daemon --stacktrace
        timeout-minutes: 15

      - name: ğŸ’¾ APKã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: intentpad-debug-apk
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 7

  create-release:
    name: ğŸ·ï¸ ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆ
    needs: build-apk
    if: ${{ needs.build-apk.result == 'success' }}
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    steps:
      - name: ğŸ” ãƒªãƒªãƒ¼ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ±ºå®š
        id: params
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "æ‰‹å‹•å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰"
            RELEASE_TAG="${{ github.event.inputs.release_tag }}"
            RELEASE_NAME="${{ github.event.inputs.release_name }}"
            IS_PRERELEASE="${{ github.event.inputs.is_prerelease }}"
          else
            echo "ã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥ãƒ¢ãƒ¼ãƒ‰"
            RELEASE_TAG="${GITHUB_REF#refs/tags/}"
            RELEASE_NAME="${RELEASE_TAG}"
            IS_PRERELEASE="false"
          fi
          echo "ã‚¿ã‚°: $RELEASE_TAG"
          echo "åå‰: $RELEASE_NAME"
          echo "ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹: $IS_PRERELEASE"
          
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV
          echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV
          echo "IS_PRERELEASE=$IS_PRERELEASE" >> $GITHUB_ENV

      - name: ğŸ“¥ ãƒ“ãƒ«ãƒ‰æ¸ˆã¿APKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: intentpad-debug-apk

      - name: ğŸš€ GitHubãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆ
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          draft: false
          prerelease: ${{ env.IS_PRERELEASE == 'true' }}
          files: |
            app-debug.apk
          generate_release_notes: true
          body: |
            è‡ªå‹•ç”Ÿæˆãƒªãƒªãƒ¼ã‚¹
            - ãƒ“ãƒ«ãƒ‰æ—¥æ™‚: ${{ github.event.repository.updated_at }}
            - ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
