name: Android Build & Release

on:
  # 1. ã‚¿ã‚°ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ãŸã¨ãã«ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
  push:
    tags:
      - 'v*'  # v1.0, v1.0.1, v2.0 ãªã©
  
  # 2. æ‰‹å‹•ã§å®Ÿè¡Œã™ã‚‹ã¨ãï¼ˆUIã‹ã‚‰ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ï¼‰
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°åï¼ˆä¾‹: v1.0ï¼‰'
        required: true
        default: 'v1.0'
      release_name:
        description: 'ãƒªãƒªãƒ¼ã‚¹åï¼ˆä¾‹: åˆå›ãƒªãƒªãƒ¼ã‚¹ï¼‰'
        required: true
        default: 'æ–°è¦ãƒªãƒªãƒ¼ã‚¹'
      is_prerelease:
        description: 'ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹ï¼ˆãƒ™ãƒ¼ã‚¿ç‰ˆï¼‰ã§ã™ã‹ï¼Ÿ'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

# ãƒªãƒªãƒ¼ã‚¹ä½œæˆã«å¿…è¦ãªæ¨©é™
permissions:
  contents: write  # âœ… ãƒªãƒªãƒ¼ã‚¹ä½œæˆã«å¿…é ˆ

jobs:
  # ãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    # ---------- ã‚¹ãƒ†ãƒƒãƒ—1: ã‚³ãƒ¼ãƒ‰å–å¾— ----------
    - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ã‚¿ã‚°æƒ…å ±ã‚‚å–å¾—

    # ---------- ã‚¹ãƒ†ãƒƒãƒ—2: Javaã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ----------
    - name: â˜• Java 17ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # ---------- ã‚¹ãƒ†ãƒƒãƒ—3: Gradleã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ----------
    - name: ğŸ› ï¸ Gradleã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: 8.5

    # ---------- ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ“ãƒ«ãƒ‰å‰ã®æº–å‚™ ----------
    - name: ğŸ”§ ãƒ“ãƒ«ãƒ‰è¨­å®šã‚’ç¢ºèª
      run: |
        echo "=== ãƒ“ãƒ«ãƒ‰è¨­å®šã‚’ç¢ºèª ==="
        echo "ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚¤ãƒ™ãƒ³ãƒˆ: ${{ github.event_name }}"
        echo "ã‚¿ã‚°å: ${{ github.ref_name }}"
        echo "æ‰‹å‹•å…¥åŠ›ã‚¿ã‚°: ${{ github.event.inputs.version_tag }}"
        echo "æ‰‹å‹•å…¥åŠ›ãƒªãƒªãƒ¼ã‚¹å: ${{ github.event.inputs.release_name }}"
        echo "ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹: ${{ github.event.inputs.is_prerelease }}"
        
        # ã‚¿ã‚°åã‚’æ±ºå®šï¼ˆæ‰‹å‹•å®Ÿè¡Œã®å ´åˆã¯å…¥åŠ›å€¤ã€ã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥ã®å ´åˆã¯ã‚¿ã‚°åï¼‰
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "æ‰‹å‹•å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰"
        else
          echo "ã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥ãƒ¢ãƒ¼ãƒ‰"
        fi

    # ---------- ã‚¹ãƒ†ãƒƒãƒ—5: APKãƒ“ãƒ«ãƒ‰ ----------
    - name: ğŸ—ï¸ APKã‚’ãƒ“ãƒ«ãƒ‰
      run: |
        echo "=== APKã‚’ãƒ“ãƒ«ãƒ‰é–‹å§‹ ==="
        # ã‚¯ãƒªãƒ¼ãƒ³ã—ã¦ã‹ã‚‰ãƒ“ãƒ«ãƒ‰
        gradle clean assembleDebug
        
        echo "=== ãƒ“ãƒ«ãƒ‰å®Œäº† ==="
        echo "ç”Ÿæˆã•ã‚ŒãŸAPK:"
        find app/build/outputs/apk -name "*.apk" -type f

    # ---------- ã‚¹ãƒ†ãƒƒãƒ—6: APKã®åå‰ã‚’å¤‰æ›´ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ ----------
    - name: ğŸ“› APKã®åå‰ã‚’ãƒªãƒªãƒ¼ã‚¹ç”¨ã«å¤‰æ›´
      run: |
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³åã‚’å–å¾—
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version_tag }}"
        else
          VERSION="${{ github.ref_name }}"
        fi
        
        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®APKãƒ‘ã‚¹
        APK_PATH="app/build/outputs/apk/debug/app-debug.apk"
        
        # ãƒªãƒãƒ¼ãƒ ï¼ˆä¾‹: IntentPad-v1.0.apkï¼‰
        NEW_NAME="IntentPad-$VERSION.apk"
        
        if [ -f "$APK_PATH" ]; then
          cp "$APK_PATH" "$NEW_NAME"
          echo "âœ… APKã‚’ãƒªãƒãƒ¼ãƒ : $NEW_NAME"
          echo "APK_NAME=$NEW_NAME" >> $GITHUB_ENV
        else
          # åˆ¥ã®å ´æ‰€ã‚’æ¢ã™
          APK_FILE=$(find app/build/outputs/apk -name "*.apk" -type f | head -1)
          if [ -n "$APK_FILE" ]; then
            cp "$APK_FILE" "$NEW_NAME"
            echo "âœ… APKã‚’ãƒªãƒãƒ¼ãƒ : $NEW_NAME"
            echo "APK_NAME=$NEW_NAME" >> $GITHUB_ENV
          else
            echo "âŒ APKãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
        fi

    # ---------- ã‚¹ãƒ†ãƒƒãƒ—7: GitHubãƒªãƒªãƒ¼ã‚¹ä½œæˆ ----------
    - name: ğŸš€ GitHubãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆ
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        # ã‚¿ã‚°åï¼ˆæ‰‹å‹•å®Ÿè¡Œæ™‚ã¯å…¥åŠ›å€¤ã€ã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã¯è‡ªå‹•ï¼‰
        tag_name: ${{ github.event.inputs.version_tag || github.ref_name }}
        
        # ãƒªãƒªãƒ¼ã‚¹åï¼ˆæ‰‹å‹•å®Ÿè¡Œæ™‚ã¯å…¥åŠ›å€¤ã€ã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã¯ã‚¿ã‚°åï¼‰
        name: ${{ github.event.inputs.release_name || github.ref_name }}
        
        # ãƒªãƒªãƒ¼ã‚¹æœ¬æ–‡ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
        generate_release_notes: true
        
        # ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹ã‹ã©ã†ã‹
        prerelease: ${{ github.event.inputs.is_prerelease == 'true' || false }}
        
        # ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆãƒªãƒãƒ¼ãƒ ã—ãŸAPKï¼‰
        files: |
          IntentPad-*.apk
          app/build/outputs/apk/debug/output-metadata.json
        
        # ãƒªãƒªãƒ¼ã‚¹å¤±æ•—æ™‚ã«ã‚¿ã‚°ã‚’å‰Šé™¤ã—ãªã„ï¼ˆå®‰å…¨ã®ãŸã‚ï¼‰
        fail_on_unmatched_files: false
        
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ---------- ã‚¹ãƒ†ãƒƒãƒ—8: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æˆæœç‰©ã¨ã—ã¦ã‚‚ä¿å­˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ ----------
    - name: ğŸ’¾ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æˆæœç‰©ã¨ã—ã¦ä¿å­˜
      uses: actions/upload-artifact@v4
      with:
        name: Android-APK-${{ github.event.inputs.version_tag || github.ref_name }}
        path: |
          IntentPad-*.apk
          app/build/outputs/apk/debug/output-metadata.json
        retention-days: 30  # 30æ—¥é–“ä¿æŒ

    # ---------- ã‚¹ãƒ†ãƒƒãƒ—9: ãƒ“ãƒ«ãƒ‰æˆåŠŸé€šçŸ¥ ----------
    - name: âœ… ãƒ“ãƒ«ãƒ‰æˆåŠŸã‚’é€šçŸ¥
      run: |
        echo "========================================"
        echo "ğŸ‰ ãƒ“ãƒ«ãƒ‰ï¼†ãƒªãƒªãƒ¼ã‚¹ãŒæˆåŠŸã—ã¾ã—ãŸï¼"
        echo "ğŸ“± APK: IntentPad-${{ github.event.inputs.version_tag || github.ref_name }}.apk"
        echo "ğŸ·ï¸  ã‚¿ã‚°: ${{ github.event.inputs.version_tag || github.ref_name }}"
        echo "ğŸ“ ãƒªãƒªãƒ¼ã‚¹å: ${{ github.event.inputs.release_name || github.ref_name }}"
        echo "========================================"
