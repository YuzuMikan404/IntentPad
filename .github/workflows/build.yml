name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'リリースタグ'
        required: true
        default: 'v1.0'
      release_name:
        description: 'リリース名'
        required: true
        default: '新規リリース'
      is_prerelease:
        description: 'プレリリースとして公開'
        required: true
        type: boolean
        default: false

jobs:
  build-and-release:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: 8.5
    
    - name: ビルド設定を確認
      run: |
        echo "=== ビルド設定を確認 ==="
        echo "ワークフロー実行イベント: ${{ github.event_name }}"
        echo "タグ名: ${{ github.ref_name }}"
        echo "手動入力タグ: ${{ inputs.release_tag }}"
        echo "手動入力リリース名: ${{ inputs.release_name }}"
        echo "プレリリース: ${{ inputs.is_prerelease }}"
        
        # タグ名を決定
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "手動実行モード"
          RELEASE_TAG="${{ inputs.release_tag }}"
          RELEASE_NAME="${{ inputs.release_name }}"
        else
          echo "タグプッシュモード"
          RELEASE_TAG="${{ github.ref_name }}"
          RELEASE_NAME="${{ github.ref_name }}"
        fi
        
        echo "最終リリースタグ: $RELEASE_TAG"
        echo "最終リリース名: $RELEASE_NAME"
        echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV
        echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV
    
    - name: 必要なリソースを作成
      run: |
        echo "=== リソースファイル作成 ==="
        
        # strings.xmlがなければ作成
        if [ ! -f app/src/main/res/values/strings.xml ]; then
          mkdir -p app/src/main/res/values
          echo '<?xml version="1.0" encoding="utf-8"?>
<resources>
    <string name="app_name">IntentPad</string>
</resources>' > app/src/main/res/values/strings.xml
        fi
        
        # themes.xmlがなければ作成
        if [ ! -f app/src/main/res/values/themes.xml ]; then
          mkdir -p app/src/main/res/values
          echo '<?xml version="1.0" encoding="utf-8"?>
<resources>
    <style name="Theme.IntentPad" parent="Theme.Material3.DayNight.NoActionBar">
        <item name="android:statusBarColor" tools:targetApi="l">?attr/colorPrimaryVariant</item>
        <item name="android:windowBackground">@android:color/white</item>
    </style>
</resources>' > app/src/main/res/values/themes.xml
        fi
    
    - name: AndroidManifest.xmlを修正（デフォルトアイコン使用）
      run: |
        echo "=== AndroidManifest.xmlを修正 ==="
        if [ -f app/src/main/AndroidManifest.xml ]; then
          # デフォルトアイコンを使用するように置換
          sed -i 's/android:icon="@mipmap\/ic_launcher"/android:icon="@android:drawable\/sym_def_app_icon"/g' app/src/main/AndroidManifest.xml
          sed -i 's/android:roundIcon="@mipmap\/ic_launcher_round"/android:roundIcon="@android:drawable\/sym_def_app_icon"/g' app/src/main/AndroidManifest.xml
          echo "AndroidManifest.xmlを修正しました"
        else
          echo "AndroidManifest.xmlが見つかりません"
        fi
    
    - name: APKをビルド
      run: |
        echo "=== APKをビルド開始 ==="
        # クリーンしてからビルド
        ./gradlew clean assembleDebug
        
        echo "=== ビルド完了 ==="
        echo "生成されたAPK:"
        find app/build/outputs/apk -name "*.apk" -type f
    
    - name: APKをアーティファクトとして保存
      uses: actions/upload-artifact@v4
      with:
        name: intentpad-apk
        path: app/build/outputs/apk/**/*.apk
        retention-days: 7
    
    - name: リリースを作成
      if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        name: ${{ env.RELEASE_NAME }}
        draft: false
        prerelease: ${{ inputs.is_prerelease }}
        files: app/build/outputs/apk/**/*.apk
        generate_release_notes: true
