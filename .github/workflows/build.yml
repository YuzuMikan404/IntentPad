name: ğŸš€ ãƒ“ãƒ«ãƒ‰ & ãƒªãƒªãƒ¼ã‚¹ (Build and Release)

# 1. ãƒˆãƒªã‚¬ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®š
on:
  # ã‚¿ã‚°ãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸã¨ãï¼ˆè‡ªå‹•ãƒªãƒªãƒ¼ã‚¹ç”¨ï¼‰
  push:
    tags:
      - 'v*'
  # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ [citation:2][citation:8]
  workflow_dispatch:
    # æ‰‹å‹•å®Ÿè¡Œæ™‚ã®å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å®šç¾©
    inputs:
      release_tag:
        description: 'ä½œæˆã™ã‚‹ãƒªãƒªãƒ¼ã‚¹ã®ã‚¿ã‚°å (ä¾‹: v1.0.0)'
        required: true
        default: 'v1.0.0'
        type: string
      release_name:
        description: 'GitHubãƒªãƒªãƒ¼ã‚¹ã®ã‚¿ã‚¤ãƒˆãƒ«'
        required: true
        default: 'æ–°è¦ãƒªãƒªãƒ¼ã‚¹'
        type: string
      is_prerelease:
        description: 'ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹ï¼ˆãƒ™ãƒ¼ã‚¿ç‰ˆï¼‰ã¨ã—ã¦å…¬é–‹ã™ã‚‹'
        required: true
        type: boolean
        default: false

# 2. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
env:
  # ä¾å­˜é–¢ä¿‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚­ãƒ¼ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¿½åŠ ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œã‚’å›é¿ï¼‰[citation:3]
  CACHE_VERSION: v1

# 3. å®Ÿè¡Œã™ã‚‹ã‚¸ãƒ§ãƒ–ã®å®šç¾©
jobs:
  # æœ€åˆã®ã‚¸ãƒ§ãƒ–: APKã®ãƒ“ãƒ«ãƒ‰
  build-apk:
    name: ğŸ”¨ APKã‚’ãƒ“ãƒ«ãƒ‰
    # GitHubãŒæä¾›ã™ã‚‹Ubuntuæœ€æ–°ç’°å¢ƒã§å®Ÿè¡Œ
    runs-on: ubuntu-24.04
    # ã“ã®ã‚¸ãƒ§ãƒ–ã§å¿…è¦ãªæ¨©é™ã‚’æ˜ç¤ºçš„ã«æŒ‡å®šï¼ˆæ›¸ãè¾¼ã¿æ¨©é™ãªã©ï¼‰[citation:3]
    permissions:
      contents: read

    steps:
      # ã‚¹ãƒ†ãƒƒãƒ— 3.1: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ğŸ“¥ ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ã™ã¹ã¦ã®å±¥æ­´ã‚’å–å¾—

      # ã‚¹ãƒ†ãƒƒãƒ— 3.2: JDK 17ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: â˜• Javaç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (JDK 17)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # ã‚¹ãƒ†ãƒƒãƒ— 3.3: Gradleã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      - name: âš™ï¸ Gradleã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.5'
          # ä¾å­˜é–¢ä¿‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–ï¼ˆãƒ“ãƒ«ãƒ‰æ™‚é–“ã‚’çŸ­ç¸®ï¼‰[citation:3]
          cache-disabled: false

      # ã‚¹ãƒ†ãƒƒãƒ— 3.4: è¶³ã‚Šãªã„ãƒªã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•ç”Ÿæˆï¼ˆãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
      - name: ğŸ› ï¸ ãƒªã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ/ä¿®æ­£
        run: |
          echo "=== è¶³ã‚Šãªã„ãƒªã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è£œå®Œ ==="
          
          # å¿…é ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p app/src/main/res/xml
          
          # strings.xml ãŒãªã‘ã‚Œã°ä½œæˆ
          if [ ! -f app/src/main/res/values/strings.xml ]; then
            mkdir -p app/src/main/res/values
            cat > app/src/main/res/values/strings.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string name="app_name">IntentPad</string>
          </resources>
          EOF
            echo "  ä½œæˆ: strings.xml"
          fi
          
          # file_paths.xml ãŒãªã‘ã‚Œã°ä½œæˆ (FileProviderç”¨)
          if [ ! -f app/src/main/res/xml/file_paths.xml ]; then
            cat > app/src/main/res/xml/file_paths.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <paths xmlns:android="http://schemas.android.com/apk/res/android">
              <external-path name="external_files" path="." />
          </paths>
          EOF
            echo "  ä½œæˆ: file_paths.xml"
          fi
          
          # AndroidManifest.xml ã®ã‚¢ã‚¤ã‚³ãƒ³è¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«å¼·åˆ¶ä¿®æ­£
          if [ -f app/src/main/AndroidManifest.xml ]; then
            sed -i 's|@mipmap/ic_launcher|@android:drawable/sym_def_app_icon|g' app/src/main/AndroidManifest.xml
            sed -i 's|@mipmap/ic_launcher_round|@android:drawable/sym_def_app_icon|g' app/src/main/AndroidManifest.xml
            echo "  ä¿®æ­£: AndroidManifest.xml ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š"
          fi

      # ã‚¹ãƒ†ãƒƒãƒ— 3.5: ãƒ‡ãƒãƒƒã‚°APKã‚’ãƒ“ãƒ«ãƒ‰
      - name: ğŸ“¦ Debug APKã‚’ãƒ“ãƒ«ãƒ‰
        run: |
          echo "=== APKãƒ“ãƒ«ãƒ‰ã‚’é–‹å§‹ ==="
          ./gradlew clean assembleDebug --no-daemon --stacktrace
        # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®šã—ã€ãƒãƒ³ã‚°ã‚¢ãƒƒãƒ—ã‚’é˜²æ­¢[citation:3]
        timeout-minutes: 15

      # ã‚¹ãƒ†ãƒƒãƒ— 3.6: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: ğŸ’¾ APKã‚’ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
        uses: actions/upload-artifact@v4
        with:
          name: intentpad-debug-apk
          path: |
            app/build/outputs/apk/debug/*.apk
            app/build/outputs/mapping/debug/mapping.txt
          retention-days: 7

  # æ¬¡ã®ã‚¸ãƒ§ãƒ–: GitHubãƒªãƒªãƒ¼ã‚¹ã®ä½œæˆï¼ˆãƒ“ãƒ«ãƒ‰æˆåŠŸå¾Œã«å®Ÿè¡Œï¼‰
  create-release:
    name: ğŸ·ï¸ GitHubãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆ
    # ãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ[citation:1][citation:7]
    needs: build-apk
    if: ${{ needs.build-apk.result == 'success' }}
    runs-on: ubuntu-24.04
    # ãƒªãƒªãƒ¼ã‚¹ä½œæˆã«ã¯ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ãŒå¿…è¦[citation:3]
    permissions:
      contents: write

    # ã‚¸ãƒ§ãƒ–ã®å‡ºåŠ›ã‚’å®šç¾©ï¼ˆå¾Œç¶šã®ã‚¸ãƒ§ãƒ–ã§åˆ©ç”¨å¯èƒ½ï¼‰
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}

    steps:
      # ã‚¹ãƒ†ãƒƒãƒ— 4.1: æ‰‹å‹•å®Ÿè¡Œã‹ã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥ã‹ã‚’åˆ¤å®šã—ã€ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚’æ±ºå®š
      - name: ğŸ” ãƒªãƒªãƒ¼ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ±ºå®š
        id: determine_params
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "ğŸ”§ æ‰‹å‹•å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰"
            RELEASE_TAG="${{ inputs.release_tag }}"
            RELEASE_NAME="${{ inputs.release_name }}"
            IS_PRERELEASE="${{ inputs.is_prerelease }}"
          else
            echo "ğŸ·ï¸ ã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥ãƒ¢ãƒ¼ãƒ‰"
            RELEASE_TAG="${GITHUB_REF#refs/tags/}" # 'refs/tags/v1.0' -> 'v1.0'
            RELEASE_NAME="${RELEASE_TAG}"
            IS_PRERELEASE="false"
          fi
          echo "æ±ºå®šã—ãŸã‚¿ã‚°: $RELEASE_TAG"
          echo "æ±ºå®šã—ãŸåå‰: $RELEASE_NAME"
          
          # ç’°å¢ƒå¤‰æ•°ã¨ã‚¸ãƒ§ãƒ–å‡ºåŠ›ã¨ã—ã¦è¨­å®š
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV
          echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV
          echo "IS_PRERELEASE=$IS_PRERELEASE" >> $GITHUB_ENV
          
          # å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ãˆã‚‹ã‚ˆã†ã«å‡ºåŠ›ã‚‚è¨­å®š
          echo "tag_name=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT

      # ã‚¹ãƒ†ãƒƒãƒ— 4.2: GitHubãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆ
      - name: ğŸš€ ãƒªãƒªãƒ¼ã‚¹è‰æ¡ˆã‚’ä½œæˆ
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          draft: false # ä¸‹æ›¸ãã§ã¯ãªãã™ãã«å…¬é–‹
          prerelease: ${{ env.IS_PRERELEASE == 'true' }}
          generate_release_notes: true
        env:
          # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«GitHubãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¸¡ã™
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æœ€çµ‚ã‚¸ãƒ§ãƒ–: ãƒªãƒªãƒ¼ã‚¹ã¸ã®APKã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆä½œæˆã‚¸ãƒ§ãƒ–ã«ä¾å­˜ï¼‰
  upload-to-release:
    name: â¬†ï¸ APKã‚’ãƒªãƒªãƒ¼ã‚¹ã«æ·»ä»˜
    needs: create-release
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    steps:
      # ã‚¹ãƒ†ãƒƒãƒ— 5.1: å‰ã®ã‚¸ãƒ§ãƒ–ã§ãƒ“ãƒ«ãƒ‰ã—ãŸAPKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - name: ğŸ“¥ ãƒ“ãƒ«ãƒ‰æ¸ˆã¿APKã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: intentpad-debug-apk

      # ã‚¹ãƒ†ãƒƒãƒ— 5.2: APKãƒ•ã‚¡ã‚¤ãƒ«ã‚’GitHubãƒªãƒªãƒ¼ã‚¹ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: ğŸ“¤ ãƒªãƒªãƒ¼ã‚¹ã«APKã‚’æ·»ä»˜
        uses: softprops/action-gh-release@v1
        with:
          # ç›´å‰ã®`create-release`ã‚¸ãƒ§ãƒ–ã®å‡ºåŠ›ã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰URLã‚’å–å¾—[citation:7]
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          files: |
            app-debug.apk
          body: |
            ã“ã®ãƒªãƒªãƒ¼ã‚¹ã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
            - **ãƒ“ãƒ«ãƒ‰æ—¥æ™‚:** ${{ github.event.repository.updated_at }}
            - **ã‚³ãƒŸãƒƒãƒˆ:** ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
