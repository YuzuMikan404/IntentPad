name: LIMEs-Neo Daily Build

on:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'æ—¢å­˜ã®ãƒ“ãƒ«ãƒ‰ã‚’ä¸Šæ›¸ãã—ã¦å¼·åˆ¶å†ãƒ“ãƒ«ãƒ‰'
        required: false
        default: true
        type: boolean
      build_type:
        description: 'ãƒ“ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—'
        required: false
        default: 'release'
        type: string
        options:
          - release
          - debug
          - both
  schedule:
    - cron: '0 0 * * *'
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'LICENSE'
      - 'docs/**'
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  packages: read

env:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  ANDROID_HOME: /usr/local/lib/android/sdk

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    env:
      SOURCE_REPO: areteruhiro/PrtivateLIMEs
      MY_PAT: ${{ secrets.PAT }}
      # ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è‡ªä½“ã®æ–°ã—ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å
      NEW_PKG: "io.github.fork.lime"
      APP_NAME: "LIMEs-Neo"

    steps:
      - name: Debug Workflow Dispatch Inputs
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "GitHub Event Name: ${{ github.event_name }}"
          echo "Force Rebuild Input: ${{ github.event.inputs.force_rebuild }}"
          echo "Build Type Input: ${{ github.event.inputs.build_type }}"

      - name: Checkout Local Repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Determine Trigger Type
        id: trigger
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "TRIGGER_TYPE=manual" >> $GITHUB_ENV
            echo "BUILD_NEEDED=true" >> $GITHUB_ENV
            FORCE_REBUILD="${{ github.event.inputs.force_rebuild }}"
            if [[ -z "$FORCE_REBUILD" || "$FORCE_REBUILD" == "true" ]]; then
              echo "FORCE_REBUILD=true" >> $GITHUB_ENV
            else
              echo "FORCE_REBUILD=false" >> $GITHUB_ENV
            fi
            BUILD_TYPE="${{ github.event.inputs.build_type }}"
            if [[ -z "$BUILD_TYPE" ]]; then BUILD_TYPE="release"; fi
            echo "BUILD_TYPE=$BUILD_TYPE" >> $GITHUB_ENV
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "TRIGGER_TYPE=scheduled" >> $GITHUB_ENV
            echo "FORCE_REBUILD=false" >> $GITHUB_ENV
            echo "BUILD_TYPE=release" >> $GITHUB_ENV
          else
            echo "TRIGGER_TYPE=other" >> $GITHUB_ENV
            echo "FORCE_REBUILD=false" >> $GITHUB_ENV
            echo "BUILD_TYPE=release" >> $GITHUB_ENV
            echo "BUILD_NEEDED=true" >> $GITHUB_ENV
          fi

      - name: Check for Scheduled Build
        if: env.TRIGGER_TYPE == 'scheduled'
        run: |
          AUTH_URL="https://x-access-token:${MY_PAT}@github.com/${SOURCE_REPO}.git"
          UPSTREAM_SHA=$(git ls-remote "$AUTH_URL" HEAD | awk '{print $1}')
          SHORT_SHA=${UPSTREAM_SHA:0:7}
          BASE_TAG="build-$SHORT_SHA"
          if git ls-remote --tags origin "refs/tags/$BASE_TAG" >/dev/null 2>&1; then
            echo "BUILD_NEEDED=false" >> $GITHUB_ENV
          else
            echo "BUILD_NEEDED=true" >> $GITHUB_ENV
            echo "UPSTREAM_SHA=$UPSTREAM_SHA" >> $GITHUB_ENV
            echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
            echo "TARGET_TAG=$BASE_TAG" >> $GITHUB_ENV
          fi

      - name: Setup Manual Build
        if: env.TRIGGER_TYPE == 'manual' && env.BUILD_NEEDED == 'true'
        run: |
          AUTH_URL="https://x-access-token:${MY_PAT}@github.com/${SOURCE_REPO}.git"
          UPSTREAM_SHA=$(git ls-remote "$AUTH_URL" HEAD | awk '{print $1}')
          SHORT_SHA=${UPSTREAM_SHA:0:7}
          BASE_TAG="build-$SHORT_SHA"
          echo "UPSTREAM_SHA=$UPSTREAM_SHA" >> $GITHUB_ENV
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
          if [[ "$FORCE_REBUILD" == "true" ]]; then
            echo "TARGET_TAG=$BASE_TAG" >> $GITHUB_ENV
          else
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            echo "TARGET_TAG=${BASE_TAG}-manual-${TIMESTAMP}" >> $GITHUB_ENV
          fi

      - name: Setup Other Trigger Build
        if: env.TRIGGER_TYPE == 'other' && env.BUILD_NEEDED == 'true'
        run: |
          CURRENT_SHA="${{ github.sha }}"
          SHORT_SHA=${CURRENT_SHA:0:7}
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          echo "UPSTREAM_SHA=$CURRENT_SHA" >> $GITHUB_ENV
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
          echo "TARGET_TAG=build-$SHORT_SHA-$TIMESTAMP" >> $GITHUB_ENV

      - name: Skip Build if Not Needed
        if: env.BUILD_NEEDED != 'true'
        run: exit 0

      - name: Get Build Datetime
        if: env.BUILD_NEEDED == 'true'
        run: |
          echo "BUILD_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "BUILD_TIME=$(date +'%H:%M:%S')" >> $GITHUB_ENV

      - name: Fetch Source Code
        if: env.BUILD_NEEDED == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git remote add upstream "https://x-access-token:${MY_PAT}@github.com/${SOURCE_REPO}.git" || true
          git fetch upstream
          git checkout $UPSTREAM_SHA

      - name: Setup Java
        if: env.BUILD_NEEDED == 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        if: env.BUILD_NEEDED == 'true'
        uses: android-actions/setup-android@v3

      # === ä¿®æ­£ç®‡æ‰€: LSPatchèªè­˜ç‡å‘ä¸Šã®ãŸã‚ã®è¨­å®š ===
      - name: Configure Scope & Package Names
        if: env.BUILD_NEEDED == 'true'
        run: |
          echo "=== ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®šã®é©ç”¨ ==="
          
          OLD_PKG="io.github.hiro.lime"
          NEW_PKG="io.github.fork.lime"
          
          # 1. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è‡ªä½“ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã‚’å¤‰æ›´ (ç«¶åˆå›é¿)
          echo "ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«IDç½®æ›: $OLD_PKG -> $NEW_PKG"
          find . -type f \( -name "*.xml" -o -name "*.java" -o -name "*.kt" -o -name "*.gradle" \) \
            ! -path "*/build/*" ! -path "*/.git/*" \
            -exec sed -i "s|$OLD_PKG|$NEW_PKG|g" {} +

          # 2. Scopeå®šç¾©ã‚’ã€Œé…åˆ—ãƒªã‚½ãƒ¼ã‚¹ã€ã«å¤‰æ›´ã—ã¦ã€ã‚ªãƒªã‚¸ãƒŠãƒ«ã¨Cloneä¸¡æ–¹ã‚’å¯¾è±¡ã«ã™ã‚‹
          echo "LSPatchç”¨Scopeå®šç¾©ã®å¼·åŒ– (Cloneå¯¾å¿œ)"
          
          # æ—¢å­˜ã® xposedscope ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãæ›ãˆ (value="..." -> resource="@array/...")
          # â€»ã“ã“ã§ã¯å˜ç´”ãªæ–‡å­—åˆ—ç½®æ›ã§ã¯ãªãã€Scopeè¨­å®šè¡Œã‚’ç‹™ã£ã¦ç½®æ›ã—ã¾ã™
          find . -name "AndroidManifest.xml" ! -path "*/build/*" \
            -exec sed -i 's|android:name="xposedscope"[[:space:]]*android:value="[^"]*"|android:name="xposedscope" android:resource="@array/xposed_scope"|g' {} +

          # æ–°ã—ã„é…åˆ—ãƒªã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          # ã“ã‚Œã«ã‚ˆã‚Šã€LSPatch Managerã¯å…¬å¼LINEã§ã‚‚Cloneã§ã‚‚èªè­˜ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™
          mkdir -p app/src/main/res/values
          cat <<EOF > app/src/main/res/values/scope_list.xml
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <string-array name="xposedscope">
                  <item>jp.naver.line.android</item>
                  <item>jp.naver.line.android.clone</item>
              </string-array>
          </resources>
          EOF
          echo "âœ… scope_list.xml ã‚’ä½œæˆã—ã¾ã—ãŸ"

          # 3. ãƒ•ãƒƒã‚¯åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã®ç·©å’Œ
          #    ã‚¯ãƒ©ã‚¹åã‚„Importæ–‡ã¯å£Šã•ãšã«ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åãƒã‚§ãƒƒã‚¯ã ã‘ã‚’ç·©ã‚ã¾ã™
          echo "ãƒ•ãƒƒã‚¯åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã®èª¿æ•´"
          
          # '== "jp.naver.line.android"' -> '.startsWith("jp.naver.line.android")'
          find . -type f \( -name "*.kt" -o -name "*.java" \) ! -path "*/build/*" \
            -exec sed -i 's|== "jp.naver.line.android"|.startsWith("jp.naver.line.android")|g' {} +
            
          # '!= "jp.naver.line.android"' -> '!...startsWith(...)'
          find . -type f \( -name "*.kt" -o -name "*.java" \) ! -path "*/build/*" \
            -exec sed -i 's|!= "jp.naver.line.android"|!it.packageName.startsWith("jp.naver.line.android")|g' {} +

          # å¤‰æ•°æ¯”è¼ƒç”¨ (equals -> startsWith)
          find . -type f \( -name "*.kt" -o -name "*.java" \) ! -path "*/build/*" \
            -exec sed -i 's|equals("jp.naver.line.android")|startsWith("jp.naver.line.android")|g' {} +

          echo "âœ… è¨­å®šå®Œäº†"

      - name: Unify Application Name
        if: env.BUILD_NEEDED == 'true'
        run: |
          find . -name "AndroidManifest.xml" -type f ! -path "*/build/*" ! -path "*/.git/*" 2>/dev/null | \
            while read file; do
              sed -i 's|android:label="[^"]*"|android:label="LIMEs-Neo"|g' "$file"
            done
          find . -name "strings.xml" -type f ! -path "*/build/*" ! -path "*/.git/*" 2>/dev/null | \
            while read file; do
              sed -i 's|<string name="app_name">[^<]*</string>|<string name="app_name">LIMEs-Neo</string>|g' "$file"
            done

      - name: Set Gradle Permissions
        if: env.BUILD_NEEDED == 'true'
        run: |
          if [[ -f "gradlew" ]]; then chmod +x gradlew; fi

      - name: Build APK
        if: env.BUILD_NEEDED == 'true'
        run: |
          echo "=== APKãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ ==="
          BUILD_COMMANDS=()
          if [[ "$BUILD_TYPE" == "release" || "$BUILD_TYPE" == "both" ]]; then
            BUILD_COMMANDS+=("assembleRelease")
          fi
          if [[ "$BUILD_TYPE" == "debug" || "$BUILD_TYPE" == "both" ]]; then
            BUILD_COMMANDS+=("assembleDebug")
          fi
          
          ./gradlew clean 2>&1 | tail -20 || true
          
          for cmd in "${BUILD_COMMANDS[@]}"; do
            echo "å®Ÿè¡Œä¸­: ./gradlew $cmd"
            if ./gradlew $cmd --stacktrace --no-daemon 2>&1; then
              echo "âœ… $cmd æˆåŠŸ"
              echo "BUILD_RESULT=${cmd#assemble}" >> $GITHUB_ENV
            else
              echo "âŒ $cmd å¤±æ•—"
              exit 1
            fi
          done

      - name: Create GitHub Release
        if: env.BUILD_NEEDED == 'true' && success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TARGET_TAG }}
          name: LIMEs-Neo ${{ env.SHORT_SHA }} (${{ env.BUILD_DATE }})
          body: |
            # ğŸš€ LIMEs-Neo ãƒ“ãƒ«ãƒ‰
            
            - **ã‚½ãƒ¼ã‚¹**: ${{ env.SHORT_SHA }}
            - **LSPatchã‚¹ã‚³ãƒ¼ãƒ—**: å…¬å¼(`jp.naver.line.android`) / Clone(`...clone`) ä¸¡å¯¾å¿œ
            
            â€» LSPatch Managerã§ Cloneã‚¢ãƒ—ãƒªã‚‚æ­£ã—ãèªè­˜ã•ã‚Œã‚‹ã‚ˆã†ã«ã‚¹ã‚³ãƒ¼ãƒ—è¨­å®šã‚’å¼·åŒ–ã—ã¾ã—ãŸã€‚
          draft: false
          prerelease: false
          overwrite: ${{ env.FORCE_REBUILD == 'true' && true || false }}
          files: |
            **/build/outputs/apk/**/*.apk
            *.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build Completion Notification
        if: always()
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "âœ… ãƒ“ãƒ«ãƒ‰æˆåŠŸï¼"
            echo "ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: jp.naver.line.android & .clone (Dual Scope)"
          else
            echo "âŒ ãƒ“ãƒ«ãƒ‰å¤±æ•—"
          fi
