name: Android Build & Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Version Tag (e.g. v1.0)'
        required: true
        default: 'v1.0'

# リリース作成権限
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: 8.5
        # キャッシュ設定を追加（オプション）
        cache-read-only: false
        cache-write-only: false

    - name: Debug - Check build.gradle file
      run: |
        echo "=== Checking build.gradle files ==="
        find . -name "build.gradle*" -type f | head -10
        echo ""
        echo "=== app/build.gradle.kts or app/build.gradle content ==="
        if [ -f "app/build.gradle.kts" ]; then
          cat app/build.gradle.kts
        elif [ -f "app/build.gradle" ]; then
          cat app/build.gradle
        else
          echo "No build.gradle file found in app directory"
        fi

    - name: Debug - Check MainActivity.kt around line 250
      run: |
        echo "=== MainActivity.kt line 240-260 ==="
        if [ -f "app/src/main/java/com/github/intent/pad/MainActivity.kt" ]; then
          sed -n '240,260p' app/src/main/java/com/github/intent/pad/MainActivity.kt
        else
          echo "MainActivity.kt not found"
          find . -name "MainActivity.kt" -type f
        fi

    - name: Clean build
      run: |
        # 完全にクリーンな状態からビルド
        echo "=== Cleaning build environment ==="
        ./gradlew clean
        # 古いキャッシュもクリア
        rm -rf ~/.gradle/caches/transforms-*
        rm -rf ~/.gradle/caches/jars-*

    - name: Build with Gradle (allow experimental APIs)
      run: |
        # 実験的APIを許可してビルド
        echo "=== Building with experimental API flags ==="
        ./gradlew assembleDebug \
          -Pkotlin.compiler.experimental.tryK2=true \
          -Pandroid.useExperimental=true \
          -Pkotlin.Experimental=allow \
          -Pandroid.enableExperimentalFoundationApi=true \
          --stacktrace \
          --no-daemon \
          --warning-mode all \
          --info

    - name: Check APK files
      run: |
        echo "=== Checking for APK files ==="
        find app/build/outputs/apk -name "*.apk" -type f | head -20
        ls -la app/build/outputs/apk/debug/ 2>/dev/null || echo "No debug APK directory"

    - name: Upload APK as Artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: Android-Debug-APK
        path: |
          app/build/outputs/apk/debug/*.apk
          app/build/outputs/apk/debug/output-metadata.json
        if-no-files-found: warn

    # リリース作成ステップ（必要に応じてコメント解除）
    # - name: Create Release
    #   uses: softprops/action-gh-release@v1
    #   if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    #   with:
    #     # 手動入力されたタグ名、またはGitのタグ名を使用
    #     tag_name: ${{ github.event.inputs.version_tag || github.ref_name }}
    #     files: app/build/outputs/apk/debug/*.apk
    #     generate_release_notes: true
